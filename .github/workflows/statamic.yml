---
name: Deploy Statamic Site

on:
  workflow_call:
    inputs:
      site_name:
        required: true
        type: string
      server:
        required: true
        type: string
      php_versions:
        required: false
        type: string
        default: '["8.3"]'

env:
  IMAGE_REGISTRY: docker.finetic.dev

jobs:
  test-backend:
    name: Test Backend (PHP ${{ matrix.php-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ${{ fromJson(inputs.php_versions) }}

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ§ª Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: phpunit-bridge
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, pgsql, exif, amqp

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache Composer dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Setup COMPOSER_AUTH
        run: |
          mkdir -p ~/.config/composer
          echo "$COMPOSER_AUTH" > ~/.config/composer/auth.json
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}

      - name: ðŸ“¦ Install Composer Dependencies
        run: |
          composer install --no-interaction --no-progress --prefer-dist --optimize-autoloader

      - name: ðŸ” Run PHP Linter (phpcs)
        run: php vendor/bin/phpcs

      - name: ðŸ§  Run PHPStan
        run: php vendor/bin/phpstan

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ§ª Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: ðŸ’¾ Restore NPM Cache
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-

      - name: ðŸ“¦ Install NPM Dependencies
        run: npm clean-install

      - name: ðŸ” Run NPM Audit
        run: npm audit signatures

      - name: ðŸ” Run Frontend Linter
        run: npm run lint

      - name: ðŸ› ï¸ Build Frontend Assets
        run: npm run build

  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    env:
      IMAGE_NAME: statamic-${{ inputs.site_name }}
      DOCKER_IMAGE_TAG: ${{ github.ref == 'refs/heads/main' && 'production' || 'acceptance' }}
      DOCKER_DIRECTORY: ${{ github.ref == 'refs/heads/main'
        && format('{0}-website/{0}-prod', inputs.site_name)
        || format('{0}/{0}-acc', inputs.site_name) }}

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Docker Login to Nexus Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ secrets.nexus_docker_username }}
          password: ${{ secrets.nexus_docker_password }}

      - name: ðŸ’¾ Restore Docker Build Cache
        uses: actions/cache@v5
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: buildx-

      - name: ðŸ—ï¸ Build & Push Docker Image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --label "vendor=Finetic" \
            --build-arg GIT_REVISION=${GITHUB_SHA} \
            --build-arg GIT_USER_NAME=$GIT_USER_NAME \
            --build-arg GIT_PRIVATE_SSH_KEY="${{ secrets.git_private_ssh_key }}" \
            -t "$IMAGE_REGISTRY/finetic/websites/${{ env.IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}" \
            --file docker/prod/Dockerfile \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new

      - name: ðŸ“¦ Save Docker Build Cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/acceptance' }}

    steps:
      - name: ðŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.deployment_key }}" > ~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519

      - name: ðŸš€ Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=accept-new -i ~/.ssh/id_ed25519 deployment@${{ inputs.server }} "
            docker compose -f /opt/docker/${{ env.DOCKER_DIRECTORY }}/docker-compose.yml pull &&
            docker compose -f /opt/docker/${{ env.DOCKER_DIRECTORY }}/docker-compose.yml up -d \
            --pull always --no-deps \
          "
